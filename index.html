<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>æ¨æ£®æ£®ä¸“å±çš„å°æ¸¸æˆ</title>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  body {
    font-family: 'Arial', sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    font-size: 16px;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
  }

  .game-container {
    position: relative;
    width: 100vw;
    height: 100vh;
    height: calc(var(--vh, 1vh) * 100);
    background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
    padding-left: env(safe-area-inset-left);
    padding-right: env(safe-area-inset-right);
  }

  /* å¼€å§‹é¡µé¢ */
  .start-screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    text-align: center;
    z-index: 100;
  }

  .start-title {
    font-size: 2rem;
    margin-bottom: 1.5rem;
    text-shadow: 0 0 20px rgba(255,255,255,0.5);
    animation: glow 2s ease-in-out infinite alternate;
    line-height: 1.2;
  }

  .start-subtitle {
    font-size: 1rem;
    margin-bottom: 2rem;
    opacity: 0.9;
    padding: 0 20px;
    line-height: 1.4;
  }

  .start-btn {
    padding: 18px 50px;
    font-size: 1.1rem;
    background: linear-gradient(45deg, #ff6b6b, #ee5a52);
    color: white;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 8px 25px rgba(238, 90, 82, 0.3);
    min-height: 50px;
    touch-action: manipulation;
    -webkit-appearance: none;
  }

  .start-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 35px rgba(238, 90, 82, 0.4);
  }

  @keyframes glow {
    from { text-shadow: 0 0 20px rgba(255,255,255,0.5); }
    to { text-shadow: 0 0 30px rgba(255,255,255,0.8), 0 0 40px rgba(255,255,255,0.6); }
  }

  /* æ¸¸æˆç•Œé¢ */
  .game-screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    padding: 10px;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }

  .game-header {
    text-align: center;
    color: white;
    margin-bottom: 30px;
  }

  .level-info {
    font-size: 1.5rem;
    margin-bottom: 8px;
    text-shadow: 0 2px 10px rgba(0,0,0,0.3);
  }

  .score-info {
    font-size: 0.9rem;
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 15px;
    flex-wrap: wrap;
  }

  .progress-bar {
    width: 80%;
    max-width: 250px;
    height: 8px;
    background: rgba(255,255,255,0.3);
    border-radius: 4px;
    margin: 0 auto;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #00f260, #0575e6);
    width: 0%;
    transition: width 0.3s ease;
  }

  /* æ‰“åœ°é¼ åŒºåŸŸ */
  .game-board {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    width: 100%;
    max-width: 350px;
    margin: 20px auto;
    padding: 10px;
    aspect-ratio: 1;
  }

  .hole {
    width: 100%;
    height: 100%;
    min-width: 80px;
    min-height: 80px;
    max-width: 120px;
    max-height: 120px;
    background: radial-gradient(circle, #8B4513 0%, #654321 50%, #3D2914 100%);
    border-radius: 50%;
    position: relative;
    cursor: pointer;
    box-shadow: inset 0 8px 15px rgba(0,0,0,0.5);
    transition: all 0.2s ease;
    overflow: hidden;
    margin: 0 auto;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }

  .hole:hover {
    transform: scale(1.05);
  }

  .mole {
    position: absolute;
    width: 80%;
    height: 80%;
    background: linear-gradient(45deg, #ff6b6b, #ee5a52);
    border-radius: 50%;
    top: 50%;
    left: 50%;
    transform: translate(-50%, 100%);
    transition: transform 0.3s ease;
    cursor: pointer;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    z-index: 10;
    user-select: none;
    -webkit-user-select: none;
    contain: layout;
  }

  .mole.show {
    animation: bounce 0.5s ease;
    pointer-events: auto;
  }

  .mole:not(.show) {
    pointer-events: none;
  }

  .mole:before {
    content: 'ğŸ¹';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 2rem;
    pointer-events: none;
    line-height: 1;
  }

  @keyframes bounce {
    0%, 20%, 60%, 100% { transform: translate(-50%, -50%) scale(1); }
    40% { transform: translate(-50%, -50%) scale(1.1); }
    80% { transform: translate(-50%, -50%) scale(1.05); }
  }

  /* å…³å¡å®Œæˆé¡µé¢ */
  .level-complete {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
    text-align: center;
  }

  .complete-title {
    font-size: 2rem;
    margin-bottom: 1.5rem;
    animation: celebrate 1s ease-in-out;
    line-height: 1.2;
  }

  .complete-message {
    font-size: 1rem;
    margin-bottom: 2rem;
    opacity: 0.9;
    padding: 0 20px;
    line-height: 1.4;
  }

  .next-btn {
    padding: 18px 50px;
    font-size: 1.1rem;
    background: linear-gradient(45deg, #56ab2f, #a8e6cf);
    color: white;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 8px 25px rgba(86, 171, 47, 0.3);
    min-height: 50px;
    touch-action: manipulation;
    -webkit-appearance: none;
  }

  @keyframes celebrate {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }

  /* é€‰æ‹©é¡µé¢ */
  .choice-screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    text-align: center;
  }

  .choice-title {
    font-size: 1.5rem;
    margin-bottom: 2rem;
    text-shadow: 0 0 20px rgba(255,255,255,0.5);
    line-height: 1.3;
    padding: 0 20px;
  }

  .choice-buttons {
    display: flex;
    flex-direction: column;
    gap: 20px;
    align-items: center;
  }

  .choice-btn {
    padding: 18px 50px;
    font-size: 1.1rem;
    color: white;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.3s ease;
    min-height: 50px;
    touch-action: manipulation;
    -webkit-appearance: none;
    min-width: 200px;
  }

  .choice-btn.blessing {
    background: linear-gradient(45deg, #ff6b6b, #ee5a52);
    box-shadow: 0 8px 25px rgba(238, 90, 82, 0.3);
  }

  .choice-btn.animation {
    background: linear-gradient(45deg, #56ab2f, #a8e6cf);
    box-shadow: 0 8px 25px rgba(86, 171, 47, 0.3);
  }

  .choice-btn:hover {
    transform: translateY(-3px);
  }

  /* ç¥ç¦é¡µé¢ */
  .blessing-screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: none;
    background: #000;
  }

  .blessing-canvas {
    display: block;
    width: 100%;
    height: 100%;
  }

  .blessing-text {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #00ffff;
    text-align: center;
    z-index: 200;
    background: rgba(0, 0, 0, 0.8);
    padding: 20px;
    border-radius: 15px;
    border: 2px solid #00ffff;
    box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
    width: 90%;
    max-width: 350px;
    max-height: 80vh;
    overflow-y: auto;
    line-height: 1.6;
    font-size: 0.9rem;
    opacity: 0;
    animation: blessigFadeIn 3s ease-in-out 1s forwards;
    -webkit-overflow-scrolling: touch;
  }

  .blessing-title {
    font-size: 1.3rem;
    margin-bottom: 15px;
    text-shadow: 0 0 20px #00ffff;
    color: #ffffff;
    line-height: 1.3;
  }

  .blessing-content {
    text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
    margin-bottom: 15px;
    line-height: 1.6;
  }

  .blessing-signature {
    font-size: 1rem;
    color: #ffffff;
    text-shadow: 0 0 15px #00ffff;
    margin-top: 20px;
    font-style: italic;
  }

  .close-blessing {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 30px;
    height: 30px;
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid #00ffff;
    border-radius: 50%;
    color: #ffffff;
    font-size: 1.2rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    touch-action: manipulation;
  }

  .close-blessing:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
  }

  .back-to-choice {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    padding: 12px 30px;
    font-size: 1rem;
    background: linear-gradient(45deg, #56ab2f, #a8e6cf);
    color: white;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 5px 15px rgba(86, 171, 47, 0.3);
    touch-action: manipulation;
    -webkit-appearance: none;
    display: none;
    z-index: 300;
  }

  .back-to-choice:hover {
    background: linear-gradient(45deg, #4a9b28, #95d4b5);
    transform: translateX(-50%) translateY(-3px);
    box-shadow: 0 8px 20px rgba(86, 171, 47, 0.4);
  }

  @keyframes blessigFadeIn {
    from { 
      opacity: 0; 
      transform: translate(-50%, -50%) scale(0.8);
    }
    to { 
      opacity: 1; 
      transform: translate(-50%, -50%) scale(1);
    }
  }

  /* å¼•å¯¼æç¤º */
  .tutorial {
    position: fixed;
    top: 10px;
    left: 10px;
    right: 10px;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 10px;
    border-radius: 8px;
    font-size: 0.8rem;
    max-width: none;
    z-index: 1000;
    animation: fadeIn 0.5s ease;
    text-align: center;
    line-height: 1.4;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* ç‰¹æ•ˆ */
  .hit-effect {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #ffeb3b;
    font-size: 2rem;
    font-weight: bold;
    pointer-events: none;
    animation: hitEffect 1s ease-out forwards;
  }

  @keyframes hitEffect {
    0% { opacity: 1; transform: translate(-50%, -50%) scale(0.5); }
    50% { opacity: 1; transform: translate(-50%, -70%) scale(1.2); }
    100% { opacity: 0; transform: translate(-50%, -90%) scale(1.5); }
  }

  .sparkle {
    position: absolute;
    width: 10px;
    height: 10px;
    background: #ffeb3b;
    border-radius: 50%;
    pointer-events: none;
    animation: sparkle 0.8s ease-out forwards;
  }

  @keyframes sparkle {
    0% { opacity: 1; transform: scale(0); }
    50% { opacity: 1; transform: scale(1); }
    100% { opacity: 0; transform: scale(0) translateY(-50px); }
  }

  .hidden {
    display: none !important;
  }

  /* ç§»åŠ¨ç«¯é€‚é… */
  @media (max-width: 480px) {
    .start-title {
      font-size: 1.8rem;
    }
    
    .start-subtitle {
      font-size: 0.9rem;
    }
    
    .game-board {
      max-width: 300px;
      gap: 8px;
    }
    
    .hole {
      min-width: 70px;
      min-height: 70px;
      max-width: 100px;
      max-height: 100px;
    }
    
    .mole:before {
      font-size: 1.8rem;
    }
    
    .level-info {
      font-size: 1.3rem;
    }
    
    .score-info {
      font-size: 0.8rem;
      gap: 10px;
    }
    
    .blessing-text {
      width: 95%;
      padding: 15px;
      font-size: 0.85rem;
    }
    
    .blessing-title {
      font-size: 1.2rem;
    }

    .choice-title {
      font-size: 1.3rem;
    }

    .choice-btn {
      padding: 15px 40px;
      font-size: 1rem;
      min-width: 180px;
    }

    .back-to-choice {
      bottom: 15px;
      padding: 10px 25px;
      font-size: 0.9rem;
    }
  }

  /* è¶…å°å±å¹•é€‚é… */
  @media (max-width: 360px) {
    .game-board {
      max-width: 280px;
      gap: 6px;
    }
    
    .hole {
      min-width: 60px;
      min-height: 60px;
      max-width: 90px;
      max-height: 90px;
    }
    
    .mole:before {
      font-size: 1.5rem;
    }
  }

  /* æ¨ªå±é€‚é… */
  @media (orientation: landscape) and (max-height: 600px) {
    .game-screen {
      padding: 5px;
    }
    
    .game-header {
      margin-bottom: 10px;
    }
    
    .game-board {
      margin: 10px auto;
      max-width: 300px;
    }
    
    .level-info {
      font-size: 1.2rem;
      margin-bottom: 5px;
    }
    
    .score-info {
      margin-bottom: 10px;
    }
    
    .tutorial {
      top: 5px;
      left: 5px;
      right: 5px;
      padding: 8px;
      font-size: 0.75rem;
    }

    .back-to-choice {
      bottom: 10px;
      padding: 8px 20px;
      font-size: 0.85rem;
    }
  }
</style>
</head>
<body>
<div class="game-container">
  <!-- å¼€å§‹é¡µé¢ -->
  <div class="start-screen" id="startScreen">
    <h1 class="start-title">âœ¨ æ¨æ£®æ£®ä¸“å±çš„å°æ¸¸æˆ âœ¨</h1>
    <p class="start-subtitle">ä¸€ä¸ªç®€å•çš„æ‰“åœ°é¼ æ¸¸æˆ<br>å¸Œæœ›èƒ½è®©ä½ å¼€å¿ƒä¸€ç‚¹</p>
    <button class="start-btn" onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
  </div>

  <!-- æ¸¸æˆç•Œé¢ -->
  <div class="game-screen" id="gameScreen">
    <div class="game-header">
      <div class="level-info" id="levelInfo">ç¬¬ 1 å…³</div>
      <div class="score-info">
        <span>åˆ†æ•°: <span id="score">0</span></span>
        <span>æ—¶é—´: <span id="timer">30</span>s</span>
        <span>ç›®æ ‡: <span id="target">10</span></span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </div>

    <div class="tutorial" id="tutorial">
      ğŸ’¡ ç‚¹å‡»å†’å‡ºæ¥çš„åœ°é¼ å¾—åˆ†ï¼<br>
      è¾¾åˆ°ç›®æ ‡åˆ†æ•°å°±èƒ½è¿‡å…³å“¦ï½
    </div>

    <div class="game-board" id="gameBoard">
      <!-- åœ°é¼ æ´ä¼šé€šè¿‡JSç”Ÿæˆ -->
    </div>
  </div>

  <!-- å…³å¡å®Œæˆé¡µé¢ -->
  <div class="level-complete" id="levelComplete">
    <h1 class="complete-title">ğŸ‰ å…³å¡å®Œæˆï¼</h1>
    <p class="complete-message" id="completeMessage">å¤ªæ£’äº†ï¼ä½ å®Œæˆäº†ç¬¬ä¸€å…³</p>
    <button class="next-btn" id="nextBtn" onclick="nextLevel()">ä¸‹ä¸€å…³</button>
  </div>

  <!-- é€‰æ‹©é¡µé¢ -->
  <div class="choice-screen" id="choiceScreen">
    <h1 class="choice-title">ğŸ‰ æ­å–œé€šå…³ï¼</h1>
    <div class="choice-buttons">
      <button class="choice-btn blessing" onclick="showBlessing()">ğŸ’– æŸ¥çœ‹ç¥ç¦</button>
      <!-- <button class="choice-btn animation" onclick="showAnimation()">âœ¨ åªçœ‹åŠ¨ç”»</button> -->
    </div>
  </div>

  <!-- ç¥ç¦é¡µé¢ -->
  <div class="blessing-screen" id="blessingScreen">
    <canvas class="blessing-canvas" id="blessingCanvas"></canvas>
    <div class="blessing-text" id="blessingText">
      <div class="close-blessing" onclick="closeBlessingText()">Ã—</div>
      <div class="blessing-title">è‡´æ¨æ£®æ£®</div>
      <div class="blessing-content">
        èšæ•£ä¸ç”±æˆ‘ï¼Œæˆ‘æ¯”ä»»ä½•äººéƒ½çˆ±ä½ ï¼Œåœ¨æ„ä½ ï¼Œå…³æ€€ä½ ã€‚<br><br>
        æˆ‘çŸ¥é“ï¼Œå½“å‹åŠ›æç©ºæƒ…ç»ªæ—¶å€™ï¼Œå¤§è„‘ä¼šæœ¬èƒ½åœ°è¿›å…¥èŠ‚èƒ½æ¨¡å¼ï¼Œåˆ‡æ–­é«˜æ¶ˆè€—çš„å…³ç³»ï¼Œå°±åƒæ‰‹æœºä½ç”µèƒ½ä¿æŠ¤æœºåˆ¶ä¸€æ ·ã€‚<br><br>
        å¸Œæœ›æ¥ä¸‹æ¥çš„æ—¥å­ï¼Œå‹åŠ›å†å¤§ï¼Œä¸è¦è¯´æ²¡äº‹ï¼Œä½ è¦å’Œä½ æœ‹å‹è¯´ä¸€å¥ï¼š<br><br>
        <strong style="color: #ffffff; font-size: 1.3em;">"æŠ±æŠ±æˆ‘"</strong><br><br>
        ç´¯çš„æ—¶å€™çˆ±ä¹Ÿæ²¡æœ‰æ¶ˆå¤±ï¼Œè¦åšçš„ä¸æ˜¯æ¨å¼€ï¼Œè€Œæ˜¯çœŸè¯šåœ°è¡¨è¾¾è‡ªå·±ï¼Œä¸€å¥â€œæŠ±æŠ±æˆ‘å§â€å°±å¤Ÿäº†ã€‚è¿™æ ·ä½ å°±èƒ½è½»æ¾å¾ˆå¤šã€‚
      </div>
    </div>
    <button class="back-to-choice" id="backToChoice" onclick="backToChoice()">ğŸ”„ è¿”å›é€‰æ‹©</button>
  </div>
</div>

<script>
// 3Dç²’å­ç³»ç»Ÿç±»
class Vector3 {
  constructor(x = 0, y = 0, z = 0) {
    this.x = x;
    this.y = y;
    this.z = z;
  }

  copy() {
    return new Vector3(this.x, this.y, this.z);
  }

  add(v) {
    this.x += v.x;
    this.y += v.y;
    this.z += v.z;
    return this;
  }

  multiply(scalar) {
    this.x *= scalar;
    this.y *= scalar;
    this.z *= scalar;
    return this;
  }
}

class Matrix {
  static rotateX(angle) {
    const cos = Math.cos(angle);
    const sin = Math.sin(angle);
    return [
      [1, 0, 0],
      [0, cos, -sin],
      [0, sin, cos]
    ];
  }

  static rotateY(angle) {
    const cos = Math.cos(angle);
    const sin = Math.sin(angle);
    return [
      [cos, 0, sin],
      [0, 1, 0],
      [-sin, 0, cos]
    ];
  }

  static multiply(matrix, vector) {
    return new Vector3(
      matrix[0][0] * vector.x + matrix[0][1] * vector.y + matrix[0][2] * vector.z,
      matrix[1][0] * vector.x + matrix[1][1] * vector.y + matrix[1][2] * vector.z,
      matrix[2][0] * vector.x + matrix[2][1] * vector.y + matrix[2][2] * vector.z
    );
  }
}

class Particle3D {
  constructor(x, y, z) {
    this.position = new Vector3(x, y, z);
    this.size = Math.random() * 2 + 0.5;
    this.life = Math.random();
    this.maxLife = 1;
    this.color = this.getRandomBlueColor();
    this.twinkle = Math.random() * Math.PI * 2;
  }

  getRandomBlueColor() {
    const colors = [
      { r: 0, g: 180, b: 255 },    // äº®è“è‰²
      { r: 50, g: 200, b: 255 },   // å¤©è“è‰²
      { r: 100, g: 220, b: 255 },  // æµ…è“è‰²
      { r: 0, g: 255, b: 255 },    // é’è‰²
      { r: 150, g: 230, b: 255 },  // å†°è“è‰²
      { r: 255, g: 255, b: 255 }   // ç™½è‰²
    ];
    return colors[Math.floor(Math.random() * colors.length)];
  }

  update(rotationX, rotationY) {
    // åº”ç”¨æ—‹è½¬
    let rotatedPos = this.position.copy();
    const rotX = Matrix.rotateX(rotationX);
    const rotY = Matrix.rotateY(rotationY);
    rotatedPos = Matrix.multiply(rotX, rotatedPos);
    rotatedPos = Matrix.multiply(rotY, rotatedPos);
    this.rotatedPosition = rotatedPos;

    // ç”Ÿå‘½å‘¨æœŸå’Œé—ªçƒ
    this.life += 0.015;
    if (this.life > this.maxLife) this.life = 0;
    this.twinkle += 0.08;
  }

  project(camera, canvas) {
    const z = this.rotatedPosition.z + camera.z;
    if (z <= 0) return null;

    const scale = camera.fov / z;
    const x2d = this.rotatedPosition.x * scale + canvas.width / 2;
    const y2d = this.rotatedPosition.y * scale + canvas.height / 2;

    return {
      x: x2d,
      y: y2d,
      z: z,
      scale: scale
    };
  }

  draw(ctx, projected) {
    if (!projected) return;

    const alpha = Math.sin(this.twinkle) * 0.4 + 0.8;
    const brightness = Math.sin(this.life * Math.PI) * 0.3 + 0.7;
    const size = this.size * projected.scale * (0.8 + brightness * 0.4);

    // å¤–å±‚å…‰æ™•
    const outerGlowSize = size * 12;
    const outerGradient = ctx.createRadialGradient(
      projected.x, projected.y, 0,
      projected.x, projected.y, outerGlowSize
    );
    outerGradient.addColorStop(0, `rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${alpha * 0.4})`);
    outerGradient.addColorStop(0.4, `rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${alpha * 0.2})`);
    outerGradient.addColorStop(1, `rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, 0)`);

    ctx.fillStyle = outerGradient;
    ctx.beginPath();
    ctx.arc(projected.x, projected.y, outerGlowSize, 0, Math.PI * 2);
    ctx.fill();

    // ä¸­å±‚å…‰æ™•
    const midGlowSize = size * 6;
    const midGradient = ctx.createRadialGradient(
      projected.x, projected.y, 0,
      projected.x, projected.y, midGlowSize
    );
    midGradient.addColorStop(0, `rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${alpha * 0.7})`);
    midGradient.addColorStop(0.5, `rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${alpha * 0.4})`);
    midGradient.addColorStop(1, `rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, 0)`);

    ctx.fillStyle = midGradient;
    ctx.beginPath();
    ctx.arc(projected.x, projected.y, midGlowSize, 0, Math.PI * 2);
    ctx.fill();

    // æ ¸å¿ƒç²’å­
    ctx.fillStyle = `rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${alpha})`;
    ctx.beginPath();
    ctx.arc(projected.x, projected.y, size, 0, Math.PI * 2);
    ctx.fill();

    // é«˜å…‰ç‚¹
    ctx.fillStyle = `rgba(255, 255, 255, ${alpha * 0.8})`;
    ctx.beginPath();
    ctx.arc(projected.x - size * 0.2, projected.y - size * 0.2, size * 0.4, 0, Math.PI * 2);
    ctx.fill();
  }
}

class BlueParticles3D {
  constructor(canvas) {
    this.canvas = canvas;
    this.ctx = canvas.getContext('2d');
    this.particles = [];
    this.camera = { x: 0, y: 0, z: 250, fov: 600 };
    this.autoRotation = { x: 0, y: 0 };
    this.time = 0;
    this.isRunning = false;

    this.resize();
    this.createParticles();
    this.bindEvents();
  }

  resize() {
    this.canvas.width = window.innerWidth;
    this.canvas.height = window.innerHeight;
  }

  createParticles() {
    this.particles = [];

    // åˆ›å»ºæ•£å¼€åˆ†å¸ƒçš„ç²’å­
    for (let i = 0; i < 1200; i++) {
      const phi = Math.acos(2 * Math.random() - 1); // 0 åˆ° Ï€
      const theta = 2 * Math.PI * Math.random(); // 0 åˆ° 2Ï€
      const radius = 100 + Math.random() * 150; // æ›´å¤§çš„æ•£å¼€èŒƒå›´

      const x = radius * Math.sin(phi) * Math.cos(theta);
      const y = radius * Math.sin(phi) * Math.sin(theta);
      const z = radius * Math.cos(phi);

      this.particles.push(new Particle3D(x, y, z));
    }

    // æ·»åŠ å¤–å±‚æ›´åˆ†æ•£çš„ç²’å­
    for (let i = 0; i < 600; i++) {
      const phi = Math.acos(2 * Math.random() - 1);
      const theta = 2 * Math.PI * Math.random();
      const radius = 250 + Math.random() * 100; // æ›´è¿œçš„ç²’å­

      const x = radius * Math.sin(phi) * Math.cos(theta);
      const y = radius * Math.sin(phi) * Math.sin(theta);
      const z = radius * Math.cos(phi);

      this.particles.push(new Particle3D(x, y, z));
    }
  }

  bindEvents() {
    window.addEventListener('resize', () => {
      this.resize();
    });
  }

  drawBackground() {
    // æ·±è“è‰²èƒŒæ™¯
    const gradient = this.ctx.createRadialGradient(
      this.canvas.width / 2, this.canvas.height / 2, 0,
      this.canvas.width / 2, this.canvas.height / 2, Math.max(this.canvas.width, this.canvas.height)
    );
    gradient.addColorStop(0, 'rgba(0, 15, 40, 1)');
    gradient.addColorStop(0.5, 'rgba(0, 8, 25, 1)');
    gradient.addColorStop(1, 'rgba(0, 0, 15, 1)');
    
    this.ctx.fillStyle = gradient;
    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

    // åŠ¨æ€æ˜Ÿæ˜Ÿ
    this.ctx.fillStyle = 'rgba(100, 200, 255, 0.6)';
    for (let i = 0; i < 80; i++) {
      const x = (Math.sin(this.time * 0.0008 + i) * 0.5 + 0.5) * this.canvas.width;
      const y = (Math.cos(this.time * 0.0006 + i) * 0.5 + 0.5) * this.canvas.height;
      const size = Math.sin(this.time * 0.02 + i) * 1.5 + 1.5;
      
      this.ctx.beginPath();
      this.ctx.arc(x, y, size, 0, Math.PI * 2);
      this.ctx.fill();
    }
  }

  start() {
    this.isRunning = true;
    this.animate();
  }

  stop() {
    this.isRunning = false;
  }

  animate() {
    if (!this.isRunning) return;

    this.time++;
    
    // è‡ªåŠ¨å‘å·¦æ—‹è½¬
    this.autoRotation.y -= 0.006; // è´Ÿå€¼è¡¨ç¤ºå‘å·¦è½¬
    this.autoRotation.x = Math.sin(this.time * 0.0008) * 0.1; // è½»å¾®ä¸Šä¸‹æ‘†åŠ¨

    this.drawBackground();

    // æ›´æ–°å’ŒæŠ•å½±ç²’å­
    const projectedParticles = [];
    this.particles.forEach(particle => {
      particle.update(this.autoRotation.x, this.autoRotation.y);
      const projected = particle.project(this.camera, this.canvas);
      if (projected) {
        projectedParticles.push({ particle, projected });
      }
    });

    // æ·±åº¦æ’åº
    projectedParticles.sort((a, b) => b.projected.z - a.projected.z);

    // ç»˜åˆ¶ç²’å­
    projectedParticles.forEach(({ particle, projected }) => {
      particle.draw(this.ctx, projected);
    });

    requestAnimationFrame(() => this.animate());
  }
}

// æ‰“åœ°é¼ æ¸¸æˆç±»
class WhackAMoleGame {
  constructor() {
    console.log('åˆå§‹åŒ–æ¸¸æˆå¯¹è±¡'); // è°ƒè¯•ä¿¡æ¯
    this.currentLevel = 1;
    this.score = 0;
    this.timeLeft = 30;
    this.targets = [10, 20]; // æ¯å…³çš„ç›®æ ‡åˆ†æ•°
    this.moleSpeed = [1000, 800]; // æ¯å…³åœ°é¼ å‡ºç°é€Ÿåº¦
    this.gameTimer = null;
    this.moleTimer = null;
    this.holes = [];
    this.activeMoles = [];
    
    this.initGame();
  }

  initGame() {
    console.log('åˆå§‹åŒ–æ¸¸æˆ'); // è°ƒè¯•ä¿¡æ¯
    this.createGameBoard();
    this.bindEvents();
    console.log('æ¸¸æˆåˆå§‹åŒ–å®Œæˆï¼Œæ´ç©´æ•°é‡:', this.holes.length); // è°ƒè¯•ä¿¡æ¯
  }

  bindEvents() {
    console.log('ç»‘å®šäº‹ä»¶'); // è°ƒè¯•ä¿¡æ¯
    // çª—å£å¤§å°æ”¹å˜äº‹ä»¶
    window.addEventListener('resize', () => {
      // æ¸¸æˆç•Œé¢ä¸éœ€è¦ç‰¹æ®Šçš„resizeå¤„ç†
    });
  }

  createGameBoard() {
    const gameBoard = document.getElementById('gameBoard');
    gameBoard.innerHTML = '';
    console.log('åˆ›å»ºæ¸¸æˆæ¿'); // è°ƒè¯•ä¿¡æ¯
    
    // åˆ›å»º9ä¸ªæ´
    for (let i = 0; i < 9; i++) {
      const hole = document.createElement('div');
      hole.className = 'hole';
      hole.dataset.index = i;
      hole.id = `hole-${i}`;
      
      const mole = document.createElement('div');
      mole.className = 'mole';
      mole.dataset.index = i;
      mole.id = `mole-${i}`;
      
      // åˆå§‹åŒ–åœ°é¼ ä½ç½®
      mole.style.position = 'absolute';
      mole.style.top = '50%';
      mole.style.left = '50%';
      mole.style.transform = 'translate(-50%, 100%)';
      
      console.log(`åˆ›å»ºæ´ ${i} å’Œåœ°é¼  ${i}`); // è°ƒè¯•ä¿¡æ¯
      
      // ç»™æ´å’Œåœ°é¼ éƒ½æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œç¡®ä¿èƒ½ç‚¹åˆ°
      const clickHandler = (e) => {
        e.preventDefault();
        e.stopPropagation();
        console.log('ç‚¹å‡»äº‹ä»¶è§¦å‘ï¼Œæ´ç©´ç´¢å¼•:', i); // è°ƒè¯•ä¿¡æ¯
        this.hitMole(i);
      };
      
      mole.addEventListener('click', clickHandler);
      mole.addEventListener('touchstart', clickHandler); // ç§»åŠ¨ç«¯æ”¯æŒ
      hole.addEventListener('click', clickHandler);
      
      hole.appendChild(mole);
      gameBoard.appendChild(hole);
      this.holes.push({ hole, mole, active: false, hideTimer: null });
    }
    console.log('æ¸¸æˆæ¿åˆ›å»ºå®Œæˆï¼Œæ€»å…±', this.holes.length, 'ä¸ªæ´'); // è°ƒè¯•ä¿¡æ¯
  }

  startLevel() {
    console.log('å¼€å§‹å…³å¡:', this.currentLevel); // è°ƒè¯•ä¿¡æ¯
    this.score = 0;
    this.timeLeft = 30;
    this.updateUI();
    
    // æ˜¾ç¤ºå¼•å¯¼
    setTimeout(() => {
      const tutorial = document.getElementById('tutorial');
      if (tutorial) {
        tutorial.style.display = 'none';
      }
    }, 3000);
    
    // å¼€å§‹è®¡æ—¶
    console.log('å¼€å§‹è®¡æ—¶å™¨'); // è°ƒè¯•ä¿¡æ¯
    this.gameTimer = setInterval(() => {
      this.timeLeft--;
      const timerElement = document.getElementById('timer');
      if (timerElement) {
        timerElement.textContent = this.timeLeft;
      }
      
      if (this.timeLeft <= 0) {
        this.endLevel();
      }
    }, 1000);
    
    // å¼€å§‹ç”Ÿæˆåœ°é¼ 
    console.log('å‡†å¤‡å¼€å§‹ç”Ÿæˆåœ°é¼ '); // è°ƒè¯•ä¿¡æ¯
    this.spawnMoles();
  }

  spawnMoles() {
    const spawnInterval = this.moleSpeed[this.currentLevel - 1];
    console.log('å¼€å§‹ç”Ÿæˆåœ°é¼ ï¼Œé—´éš”:', spawnInterval); // è°ƒè¯•ä¿¡æ¯
    
    this.moleTimer = setInterval(() => {
      if (this.timeLeft <= 0) return;
      
      // éšæœºé€‰æ‹©ä¸€ä¸ªæ´
      const availableHoles = this.holes.filter(hole => !hole.active);
      console.log('å¯ç”¨æ´ç©´æ•°é‡:', availableHoles.length); // è°ƒè¯•ä¿¡æ¯
      if (availableHoles.length === 0) return;
      
      const randomHole = availableHoles[Math.floor(Math.random() * availableHoles.length)];
      console.log('é€‰ä¸­æ´ç©´ï¼Œå¼€å§‹æ˜¾ç¤ºåœ°é¼ '); // è°ƒè¯•ä¿¡æ¯
      this.showMole(randomHole);
    }, spawnInterval);
  }

  showMole(holeData) {
    console.log('æ˜¾ç¤ºåœ°é¼ '); // è°ƒè¯•ä¿¡æ¯
    
    // æ¸…é™¤ä»»ä½•ç°æœ‰çš„éšè—å®šæ—¶å™¨
    if (holeData.hideTimer) {
      clearTimeout(holeData.hideTimer);
    }
    
    holeData.active = true;
    
    // ç¡®ä¿åœ°é¼ çš„å®šä½æ­£ç¡®
    holeData.mole.style.position = 'absolute';
    holeData.mole.style.top = '50%';
    holeData.mole.style.left = '50%';
    holeData.mole.style.transform = 'translate(-50%, -50%)';
    
    holeData.mole.classList.add('show');
    
    // åœ°é¼ æ˜¾ç¤ºæ—¶é—´
    const showTime = 1500 + Math.random() * 1000;
    console.log('åœ°é¼ å°†åœ¨', showTime, 'msåéšè—'); // è°ƒè¯•ä¿¡æ¯
    
    holeData.hideTimer = setTimeout(() => {
      if (holeData.active) {
        console.log('æ—¶é—´åˆ°ï¼Œéšè—åœ°é¼ '); // è°ƒè¯•ä¿¡æ¯
        this.hideMole(holeData);
      }
    }, showTime);
  }

  hideMole(holeData) {
    console.log('éšè—åœ°é¼ '); // è°ƒè¯•ä¿¡æ¯
    
    // æ¸…é™¤éšè—å®šæ—¶å™¨
    if (holeData.hideTimer) {
      clearTimeout(holeData.hideTimer);
      holeData.hideTimer = null;
    }
    
    holeData.active = false;
    holeData.mole.classList.remove('show');
    
          // å¼ºåˆ¶é‡ç½®åœ°é¼ ä½ç½®åˆ°åœ°ä¸‹
      setTimeout(() => {
        if (!holeData.active) {
          holeData.mole.style.position = 'absolute';
          holeData.mole.style.top = '50%';
          holeData.mole.style.left = '50%';
          holeData.mole.style.transform = 'translate(-50%, 100%)';
        }
      }, 50);
    
    console.log('åœ°é¼ ç±»å:', holeData.mole.className); // è°ƒè¯•ä¿¡æ¯
  }

  hitMole(index) {
    const holeData = this.holes[index];
    console.log('ç‚¹å‡»åœ°é¼ :', index, 'æ´»è·ƒçŠ¶æ€:', holeData.active); // è°ƒè¯•ä¿¡æ¯
    
    if (!holeData.active) {
      console.log('åœ°é¼ ä¸æ´»è·ƒï¼Œç‚¹å‡»æ— æ•ˆ');
      return;
    }
    
    // éšè—åœ°é¼ 
    this.hideMole(holeData);
    
    // å¢åŠ åˆ†æ•°
    this.score++;
    console.log('åˆ†æ•°å¢åŠ åˆ°:', this.score); // è°ƒè¯•ä¿¡æ¯
    this.updateUI();
    
    // æ˜¾ç¤ºå‡»ä¸­ç‰¹æ•ˆ
    this.showHitEffect(holeData.hole);
    
    // æ£€æŸ¥æ˜¯å¦å®Œæˆå…³å¡
    if (this.score >= this.targets[this.currentLevel - 1]) {
      this.completeLevel();
    }
  }

  showHitEffect(hole) {
    // åˆ†æ•°ç‰¹æ•ˆ
    const effect = document.createElement('div');
    effect.className = 'hit-effect';
    effect.textContent = '+1';
    hole.appendChild(effect);
    
    setTimeout(() => {
      hole.removeChild(effect);
    }, 1000);
    
    // é—ªå…‰ç‰¹æ•ˆ
    for (let i = 0; i < 5; i++) {
      setTimeout(() => {
        const sparkle = document.createElement('div');
        sparkle.className = 'sparkle';
        sparkle.style.left = (Math.random() * 100) + '%';
        sparkle.style.top = (Math.random() * 100) + '%';
        hole.appendChild(sparkle);
        
        setTimeout(() => {
          if (hole.contains(sparkle)) {
            hole.removeChild(sparkle);
          }
        }, 800);
      }, i * 100);
    }
  }

  updateUI() {
    document.getElementById('score').textContent = this.score;
    document.getElementById('target').textContent = this.targets[this.currentLevel - 1];
    document.getElementById('levelInfo').textContent = `ç¬¬ ${this.currentLevel} å…³`;
    
    // æ›´æ–°è¿›åº¦æ¡
    const progress = (this.score / this.targets[this.currentLevel - 1]) * 100;
    document.getElementById('progressFill').style.width = Math.min(progress, 100) + '%';
  }

  endLevel() {
    clearInterval(this.gameTimer);
    clearInterval(this.moleTimer);
    
    // éšè—æ‰€æœ‰åœ°é¼ 
    this.hideAllMoles();
    
    if (this.score >= this.targets[this.currentLevel - 1]) {
      this.completeLevel();
    } else {
      // é‡æ–°å¼€å§‹å½“å‰å…³å¡
      setTimeout(() => {
        alert('æ—¶é—´åˆ°äº†ï¼å†è¯•ä¸€æ¬¡å§ï½');
        this.startLevel();
      }, 500);
    }
  }

  hideAllMoles() {
    console.log('éšè—æ‰€æœ‰åœ°é¼ '); // è°ƒè¯•ä¿¡æ¯
    this.holes.forEach(holeData => {
      if (holeData.active) {
        this.hideMole(holeData);
      }
    });
  }

  completeLevel() {
    clearInterval(this.gameTimer);
    clearInterval(this.moleTimer);
    
    // éšè—æ‰€æœ‰åœ°é¼ 
    this.hideAllMoles();
    
    // æ˜¾ç¤ºå®Œæˆé¡µé¢
    document.getElementById('gameScreen').style.display = 'none';
    document.getElementById('levelComplete').style.display = 'flex';
    
    const completeMessage = document.getElementById('completeMessage');
    const nextBtn = document.getElementById('nextBtn');
    
    if (this.currentLevel === 1) {
      completeMessage.textContent = 'å¤ªæ£’äº†ï¼ä½ å®Œæˆäº†ç¬¬ä¸€å…³ï¼Œç»§ç»­åŠ æ²¹ï¼';
      nextBtn.textContent = 'ä¸‹ä¸€å…³';
      nextBtn.onclick = () => this.nextLevel();
    } else {
      completeMessage.textContent = 'æ­å–œä½ ï¼æ‰€æœ‰å…³å¡éƒ½å®Œæˆäº†ï¼';
      nextBtn.textContent = 'ç‚¹å‡»æœ‰æƒŠå–œ';
      nextBtn.onclick = () => this.showBlessing();
    }
  }

  nextLevel() {
    this.currentLevel++;
    document.getElementById('levelComplete').style.display = 'none';
    document.getElementById('gameScreen').style.display = 'block';
    document.getElementById('tutorial').style.display = 'block';
    document.getElementById('tutorial').innerHTML = 'ğŸ’¡ ç¬¬äºŒå…³åœ°é¼ æ›´å¿«äº†ï¼<br>åŠ æ²¹æ‰“åˆ°20åˆ†ï¼';
    
    setTimeout(() => {
      document.getElementById('tutorial').style.display = 'none';
    }, 3000);
    
    this.startLevel();
  }

  showBlessing() {
    // æ˜¾ç¤ºé€‰æ‹©é¡µé¢
    document.getElementById('levelComplete').style.display = 'none';
    document.getElementById('choiceScreen').style.display = 'flex';
  }
}

// æ¸¸æˆæ§åˆ¶å‡½æ•°
let game;

function startGame() {
  document.getElementById('startScreen').style.display = 'none';
  document.getElementById('gameScreen').style.display = 'block';
  
  game = new WhackAMoleGame();
  game.startLevel();
}

function nextLevel() {
  game.nextLevel();
}

// å…¨å±€å˜é‡å‚¨å­˜ç²’å­ç³»ç»Ÿ
let particleSystem = null;

// æ˜¾ç¤ºç¥ç¦é¡µé¢
function showBlessing() {
  document.getElementById('choiceScreen').style.display = 'none';
  document.getElementById('blessingScreen').style.display = 'block';
  
  // å¯åŠ¨ç²’å­ç³»ç»Ÿ
  const canvas = document.getElementById('blessingCanvas');
  particleSystem = new BlueParticles3D(canvas);
  particleSystem.start();
  
  // æ˜¾ç¤ºç¥ç¦æ–‡æœ¬ï¼Œéšè—è¿”å›æŒ‰é’®
  document.getElementById('blessingText').style.display = 'block';
  document.getElementById('backToChoice').style.display = 'none';
}

// åªæ˜¾ç¤ºåŠ¨ç”»ï¼Œä¸æ˜¾ç¤ºç¥ç¦æ–‡æœ¬
function showAnimation() {
  document.getElementById('choiceScreen').style.display = 'none';
  document.getElementById('blessingScreen').style.display = 'block';
  
  // å¯åŠ¨ç²’å­ç³»ç»Ÿ
  const canvas = document.getElementById('blessingCanvas');
  particleSystem = new BlueParticles3D(canvas);
  particleSystem.start();
  
  // éšè—ç¥ç¦æ–‡æœ¬ï¼Œæ˜¾ç¤ºè¿”å›æŒ‰é’®
  document.getElementById('blessingText').style.display = 'none';
  document.getElementById('backToChoice').style.display = 'block';
}

// å…³é—­ç¥ç¦æ–‡æœ¬ï¼Œåªæ˜¾ç¤ºåŠ¨ç”»
function closeBlessingText() {
  document.getElementById('blessingText').style.display = 'none';
  document.getElementById('backToChoice').style.display = 'block';
}

// è¿”å›é€‰æ‹©é¡µé¢
function backToChoice() {
  // åœæ­¢ç²’å­ç³»ç»Ÿ
  if (particleSystem) {
    particleSystem.stop();
    particleSystem = null;
  }
  
  // éšè—ç¥ç¦é¡µé¢ï¼Œæ˜¾ç¤ºé€‰æ‹©é¡µé¢
  document.getElementById('blessingScreen').style.display = 'none';
  document.getElementById('choiceScreen').style.display = 'flex';
}

// ä¿®å¤ç§»åŠ¨ç«¯vhå•ä½é—®é¢˜
function setVH() {
  let vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
  setVH();
  console.log('H5æ‰“åœ°é¼ æ¸¸æˆåŠ è½½å®Œæˆ');
});

// çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°è®¡ç®—
window.addEventListener('resize', setVH);
window.addEventListener('orientationchange', () => {
  setTimeout(setVH, 100);
});
</script>
</body>
</html> 
